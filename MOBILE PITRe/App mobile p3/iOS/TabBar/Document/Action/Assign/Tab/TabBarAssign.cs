// This file has been autogenerated from a class added in the UI designer.

using System;
using CoreGraphics;
using Foundation;
using InformaticaTrentinaPCL.iOS.Helper;
using UIKit;

namespace InformaticaTrentinaPCL.iOS.TabBar.Document.Action.Assign.Storyboard
{
	public partial class TabBarAssign : UITabBarController
	{
        public Action<bool> CallbackItemSelected;
        private Keyboard keyboard;

		public TabBarAssign (IntPtr handle) : base (handle)
		{
		}

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();
          
            keyboard = new Keyboard();
            keyboard.RegisterForNotificationsOrientations( () => {
                SetTabbar();
            });

            if (Utility.IsTablet()) return;
            SetTabbar();
		}

        private void SetTabbar()
        {
            CreateCustomTabBar(this, 2);
            // remove top border del tabbar 
            TabBar.Layer.BorderWidth = 0.50f;
            TabBar.Layer.BorderColor = UIColor.Clear.CGColor;
            TabBar.ClipsToBounds = true;
            // fine remove
        }

        public override void ViewDidAppear(bool animated)
        {
            base.ViewDidAppear(animated);

            if (Utility.IsTablet()) 
                SetTabbar();
		}

        public override void ViewDidLayoutSubviews()
        {
            base.ViewDidLayoutSubviews();

            if (Utility.IsTablet()) return;
			CGRect tabFrame = this.TabBar.Frame;
            tabFrame.Y = 0; // y container view 
            Console.WriteLine(this.TabBar.Frame.Y + " Y");
            this.TabBar.Frame = tabFrame;
		}

        public override void ItemSelected(UITabBar tabbar, UITabBarItem item)
        {
            CallbackItemSelected(true);
        }

        public override void PrepareForSegue(UIStoryboardSegue segue, NSObject sender)
        {
            base.PrepareForSegue(segue, sender);
        }

		public UIImage ViewForImage(UIView view)
		{
			UIGraphics.BeginImageContext(view.Frame.Size);
			try
			{
				using (var context = UIGraphics.GetCurrentContext())
				{
					view.Layer.RenderInContext(context);
					return UIGraphics.GetImageFromCurrentImageContext();
				}
			}
			catch (Exception e)
			{
                Console.WriteLine(e.Message);
				return default(UIImage);
			}
			finally
			{
				UIGraphics.EndImageContext();
			}
		}

        public UIViewController[] GetUIViewController()
        {
            return this.ViewControllers;
        }
	
		public void CreateCustomTabBar(UITabBarController TabBar, int numberTab)
		{

			var frameInfo = TabBar.View.Frame;

			/* setup tab bar */
			TabBar.TabBar.InvalidateIntrinsicContentSize();
		
            nfloat tabHeight = TabBar.TabBar.Frame.Height;
		
            CGRect tabFrame = TabBar.TabBar.Frame;
			
            tabFrame.Size = new CGSize(TabBar.View.Frame.Width, tabHeight);
			tabFrame.Y = 0; // y container view 

		
			TabBar.TabBar.Frame = tabFrame; // Setto il Frame
            TabBar.TabBar.BackgroundColor = UIColor.White; // color in background

            // TESTO normale non selezionato
			UITextAttributes normalTextAttributes = new UITextAttributes();
			normalTextAttributes.Font = UIFont.SystemFontOfSize(16.0F);
            normalTextAttributes.TextColor = UIColor.DarkGray;
			UITabBarItem.Appearance.SetTitleTextAttributes(normalTextAttributes, UIControlState.Normal);

            // VIEW Linea parallela grigia prende tutti i tab dal lato sinistro fino al destro
			UIView bgTabView = new UIView(new CGRect(new CGPoint(0, 0), new CGSize(TabBar.View.Frame.Width / numberTab, tabHeight)));
			nfloat borderNormalHeight = 1f;
			UIImageView borderNormal = new UIImageView(new CGRect(new CGPoint(0, tabHeight - borderNormalHeight), new CGSize(TabBar.View.Frame.Width / numberTab, borderNormalHeight)));
            borderNormal.BackgroundColor = UIColor.DarkGray;
			bgTabView.AddSubview(borderNormal);

			TabBar.TabBar.BackgroundImage = ViewForImage(bgTabView);

			nfloat selectedBorderHeight = 4f; // altezza VIEW trattino

			// TESTO selezionato colorato 
			UITextAttributes selectedTextAttributes = new UITextAttributes();
			selectedTextAttributes.Font = UIFont.BoldSystemFontOfSize(16.0F);
            selectedTextAttributes.TextColor = Colors.COLOR_NAVIGATION;

			UITabBarItem.Appearance.SetTitleTextAttributes(selectedTextAttributes, UIControlState.Selected);

			// VIEW trattino in basso blu selezionato
			UIView bgSelectedView = new UIView(new CGRect(new CGPoint(0, 0), new CGSize(TabBar.View.Frame.Width / numberTab, tabHeight)));
			UIImageView borderSelected = new UIImageView(new CGRect(new CGPoint(0, tabHeight - selectedBorderHeight), new CGSize(TabBar.View.Frame.Width / numberTab, selectedBorderHeight)));
            borderSelected.BackgroundColor = Colors.COLOR_NAVIGATION;
			bgSelectedView.AddSubview(borderSelected);

			TabBar.TabBar.SelectionIndicatorImage = ViewForImage(bgSelectedView);
		}


	}
}

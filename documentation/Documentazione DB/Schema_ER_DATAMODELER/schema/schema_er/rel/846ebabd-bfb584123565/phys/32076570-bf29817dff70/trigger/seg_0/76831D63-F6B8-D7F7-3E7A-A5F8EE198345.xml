<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="UPDATEREPERTORITABLE" id="76831D63-F6B8-D7F7-3E7A-A5F8EE198345" directorySegmentName="seg_0">
<sourceConnName>DOCSPA_MASTER</sourceConnName>
<sourceObjSchema>DOCSPA_MASTER</sourceObjSchema>
<sourceObjName>UPDATEREPERTORITABLE</sourceObjName>
<createdBy>mw</createdBy>
<createdTime>2014-06-06 11:32:04 UTC</createdTime>
<generatorID>Generato dall&apos;utente</generatorID>
<ownerDesignName>Schema_ER</ownerDesignName>
<actions>INSERT</actions>
<body>Begin&lt;br/&gt;    /******************************************************************************&lt;br/&gt;      AUTHOR:    Samuele Furnari&lt;br/&gt;      NAME:      UpdateRepertoriTable&lt;br/&gt;      PURPOSE:   Questo trigger in ascolto sulla dpa_el_registri scatta ogni volta&lt;br/&gt;                 che viene aggiunto un registro o un RF e serve per aggiungere ad&lt;br/&gt;                 ogni contatore di repertorio di tipo AOO / RF, un riferimento&lt;br/&gt;                 al nuovo registro / RF&lt;br/&gt;    ******************************************************************************/&lt;br/&gt;    -- Cursore per scorrere tutti i repertori di RF&lt;br/&gt;    Declare Cursor RepertoriCursor (Mycha_Tipo_Tar Varchar) Is&lt;br/&gt;    (Select Oc.System_Id&lt;br/&gt;    From Dpa_Oggetti_Custom Oc&lt;br/&gt;    Where Repertorio     = &apos;1&apos;&lt;br/&gt;    And Cha_Tipo_Tar     = Mycha_Tipo_Tar -- &apos;R&apos; o &apos;A&apos;&lt;br/&gt;    And Id_Tipo_Oggetto In&lt;br/&gt;      (Select System_Id&lt;br/&gt;      From Dpa_Tipo_Oggetto&lt;br/&gt;      Where Lower(Descrizione) = &apos;contatore&apos;&lt;br/&gt;      )&lt;br/&gt;    );&lt;br/&gt;  -- Id del repertorio&lt;br/&gt;  RepId Number;&lt;br/&gt;  -- Tipo di impostazioni scelte per lo specifico repertorio&lt;br/&gt;  SettType Varchar (1);&lt;br/&gt;  -- Id del registro e dell&apos;RF&lt;br/&gt;  Registry Number;&lt;br/&gt;  Rf       Number;&lt;br/&gt;  -- Sigla identificativa del tipo di repertorio da modificare (A o R)&lt;br/&gt;  RepType Varchar (1);&lt;br/&gt;  Begin&lt;br/&gt;    -- Inizializzazione del cursore per scorrere i repertori a seconda&lt;br/&gt;    -- che si stia inserendo un RF o un Registro&lt;br/&gt;    If :New.Cha_Rf = &apos;1&apos; Then&lt;br/&gt;      RepType     := &apos;R&apos;;&lt;br/&gt;    Else&lt;br/&gt;      RepType := &apos;A&apos;;&lt;br/&gt;    End If ;&lt;br/&gt;    Begin&lt;br/&gt;      Open RepertoriCursor(RepType);&lt;br/&gt;      Loop&lt;br/&gt;        Fetch RepertoriCursor Into RepId;&lt;br/&gt;        Exit&lt;br/&gt;      When RepertoriCursor%NotFound;&lt;br/&gt;        -- Se si sta inserendo un registro viene inizializzato&lt;br/&gt;        -- il parametro registry altrimenti viene valorizzato il&lt;br/&gt;        -- parametro rf&lt;br/&gt;        If :New.Cha_Rf = &apos;0&apos; Then&lt;br/&gt;          Begin&lt;br/&gt;            Registry := :New.System_Id;&lt;br/&gt;            Rf       := Null;&lt;br/&gt;          End;&lt;br/&gt;        Else&lt;br/&gt;          Begin&lt;br/&gt;            Registry := Null;&lt;br/&gt;            Rf       := :New.System_Id;&lt;br/&gt;          End;&lt;br/&gt;        End If ;&lt;br/&gt;        -- Selezione delle impostazioni relative al contatore in esame&lt;br/&gt;        -- (viene prelevata la prima istanza in quanto una qualsiasi istanza&lt;br/&gt;        -- è sufficiente per determinare come procedere&lt;br/&gt;        Begin&lt;br/&gt;          Select SettingsType&lt;br/&gt;          Into SettType&lt;br/&gt;          From Dpa_Registri_Repertorio&lt;br/&gt;          Where CounterId = RepId&lt;br/&gt;          And Rownum      = 1;&lt;br/&gt;        Exception&lt;br/&gt;        When Others Then&lt;br/&gt;          SettType := &apos;&apos;;&lt;br/&gt;        End;&lt;br/&gt;        Begin&lt;br/&gt;          If SettType = &apos;G&apos; Then&lt;br/&gt;            Begin&lt;br/&gt;              -- Se il tipo di impostazione è G, viene inserita nell&apos;anagrafica una riga uguale&lt;br/&gt;              -- alla prima impostazione del repertorio con la data di ultima stampa impostata a null&lt;br/&gt;              -- e con l&apos;ultimo numero stampato impostato a 0&lt;br/&gt;              Insert&lt;br/&gt;              Into Dpa_Registri_Repertorio&lt;br/&gt;                (&lt;br/&gt;                  Tipologyid,&lt;br/&gt;                  Counterid,&lt;br/&gt;                  Counterstate,&lt;br/&gt;                  Settingstype,&lt;br/&gt;                  Registryid,&lt;br/&gt;                  Rfid,&lt;br/&gt;                  Rolerespid,&lt;br/&gt;                  Printerrolerespid,&lt;br/&gt;                  Printeruserrespid,&lt;br/&gt;                  Printfreq,&lt;br/&gt;                  Tipologykind,&lt;br/&gt;                  Dtastart,&lt;br/&gt;                  Dtafinish,&lt;br/&gt;                  Dtanextautomaticprint,&lt;br/&gt;                  Dtalastprint,&lt;br/&gt;                  Lastprintednumber,&lt;br/&gt;                  Resprights&lt;br/&gt;                )&lt;br/&gt;                (Select Tipologyid,&lt;br/&gt;                    CounterId,&lt;br/&gt;                    CounterState,&lt;br/&gt;                    SettingsType,&lt;br/&gt;                    Registry,&lt;br/&gt;                    Rf,&lt;br/&gt;                    RolerespId,&lt;br/&gt;                    PrinterRoleRespId,&lt;br/&gt;                    PrinterUserRespId,&lt;br/&gt;                    PrintFreq,&lt;br/&gt;                    TipologyKind,&lt;br/&gt;                    DtaStart,&lt;br/&gt;                    DtaFinish,&lt;br/&gt;                    DtaNextAutomaticPrint,&lt;br/&gt;                    Null,&lt;br/&gt;                    0,&lt;br/&gt;                    RespRights&lt;br/&gt;                  From Dpa_Registri_Repertorio&lt;br/&gt;                  Where CounterId = RepId&lt;br/&gt;                  And Rownum      = 1&lt;br/&gt;                );&lt;br/&gt;            Exception&lt;br/&gt;            When Others Then&lt;br/&gt;              SettType := &apos;&apos;;&lt;br/&gt;            End;&lt;br/&gt;          Else&lt;br/&gt;            Begin&lt;br/&gt;              If SettType = &apos;S&apos; Then&lt;br/&gt;                Begin&lt;br/&gt;                  -- Altrimenti le impostazioni sono singole per ogni repertorio.&lt;br/&gt;                  -- In questo caso, viene inserita una riga uguale alla prima istanta&lt;br/&gt;                  -- di configurazione relativa al repertorio ad esclusione di:&lt;br/&gt;                  --    - stato che viene impostato ad Aperto&lt;br/&gt;                  --    - rfid / registry id che vengono impostati a seconda del registro inserito&lt;br/&gt;                  --    - ultimo numero stampato che viene impostato a 0&lt;br/&gt;                  --    - date che vengono impostate tutte a null&lt;br/&gt;                  --    - respondabili che vengono impostati a null&lt;br/&gt;                  --    - frequenza di stampa automatica che viene impostata ad N&lt;br/&gt;                  Insert&lt;br/&gt;                  Into Dpa_Registri_Repertorio&lt;br/&gt;                    (&lt;br/&gt;                      Tipologyid,&lt;br/&gt;                      Counterid,&lt;br/&gt;                      Counterstate,&lt;br/&gt;                      Settingstype,&lt;br/&gt;                      Registryid,&lt;br/&gt;                      Rfid,&lt;br/&gt;                      Rolerespid,&lt;br/&gt;                      Printerrolerespid,&lt;br/&gt;                      Printeruserrespid,&lt;br/&gt;                      Printfreq,&lt;br/&gt;                      Tipologykind,&lt;br/&gt;                      Dtastart,&lt;br/&gt;                      Dtafinish,&lt;br/&gt;                      Dtanextautomaticprint,&lt;br/&gt;                      Dtalastprint,&lt;br/&gt;                      Lastprintednumber,&lt;br/&gt;                      Resprights&lt;br/&gt;                    )&lt;br/&gt;                    (Select Tipologyid,&lt;br/&gt;                        Counterid,&lt;br/&gt;                        Counterstate,&lt;br/&gt;                        Settingstype,&lt;br/&gt;                        Registry,&lt;br/&gt;                        Rf,&lt;br/&gt;                        Null,&lt;br/&gt;                        Null,&lt;br/&gt;                        Null,&lt;br/&gt;                        &apos;N&apos;,&lt;br/&gt;                        Tipologykind,&lt;br/&gt;                        Null,&lt;br/&gt;                        Null,&lt;br/&gt;                        Null,&lt;br/&gt;                        Null,&lt;br/&gt;                        0,&lt;br/&gt;                        Resprights&lt;br/&gt;                      From Dpa_Registri_Repertorio&lt;br/&gt;                      Where Counterid = Repid&lt;br/&gt;                      And Rownum      = 1&lt;br/&gt;                    );&lt;br/&gt;                Exception&lt;br/&gt;                When Others Then&lt;br/&gt;                  Setttype := &apos;&apos;;&lt;br/&gt;                End;&lt;br/&gt;              End If;&lt;br/&gt;            End;&lt;br/&gt;          End If;&lt;br/&gt;        End;&lt;br/&gt;      End Loop;&lt;br/&gt;    End;&lt;br/&gt;    Close Repertoricursor;&lt;br/&gt;  End;&lt;br/&gt;End;</body>
<triggerTime>AFTER</triggerTime>
<owner>695B8809-E92B-A363-7727-CAD83203B851</owner>
<table>B8688DBF-D1A6-5506-382B-170B4751F1FC</table>
</TriggerOraclev10g>
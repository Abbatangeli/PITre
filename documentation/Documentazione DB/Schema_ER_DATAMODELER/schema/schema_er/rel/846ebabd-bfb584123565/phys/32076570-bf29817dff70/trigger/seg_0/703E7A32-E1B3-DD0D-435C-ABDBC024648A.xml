<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="ROLEHISTORYMODIFY" id="703E7A32-E1B3-DD0D-435C-ABDBC024648A" directorySegmentName="seg_0">
<sourceConnName>DOCSPA_MASTER</sourceConnName>
<sourceObjSchema>DOCSPA_MASTER</sourceObjSchema>
<sourceObjName>ROLEHISTORYMODIFY</sourceObjName>
<createdBy>mw</createdBy>
<createdTime>2014-06-06 11:32:04 UTC</createdTime>
<generatorID>Generato dall&apos;utente</generatorID>
<ownerDesignName>Schema_ER</ownerDesignName>
<actions>UPDATE</actions>
<body>DECLARE&lt;br/&gt;  idLastInsert integer;&lt;br/&gt;BEGIN&lt;br/&gt;  /******************************************************************************&lt;br/&gt;&lt;br/&gt;    AUTHOR:    Samuele Furnari&lt;br/&gt;&lt;br/&gt;    NAME:      ROLEHISTORYMODIFY&lt;br/&gt;&lt;br/&gt;    PURPOSE:   Ogni volta che viene modificato un record nella dpa_corr_globali,&lt;br/&gt;               se il record è relativo ad un Ruolo, se non è stata inserita&lt;br/&gt;               la dta_fine e se è stato modificato almeno uno dei campi &lt;br/&gt;               monitorati, viene inserita una riga di tipo M nella tabella dello&lt;br/&gt;               storico. Se invece è stato impostato l&apos;id_old, significa che è&lt;br/&gt;               stato storicizzato un ruolo, quindi viene inserito un record di&lt;br/&gt;               tipo S nella tabella dello storico&lt;br/&gt; &lt;br/&gt;  ******************************************************************************/&lt;br/&gt;&lt;br/&gt;  -- Verifica eventuale cambiamento su codice del ruolo&lt;br/&gt;  if :old.id_old != :new.id_old then&lt;br/&gt;    -- Nella dpa_role_history bisogna preventivamente aggiornare il campo&lt;br/&gt;    -- role_id con il nuovo system_id ed in seguito inserire una nuova riga&lt;br/&gt;    -- con id_old uguale a quella del record appena inserito&lt;br/&gt;    UPDATE dpa_role_history&lt;br/&gt;    SET role_id = :new.id_old&lt;br/&gt;    WHERE role_id = :old.system_id;&lt;br/&gt;    &lt;br/&gt;    -- Il ruolo id_old è stato storicizzato (inserimento di un record &lt;br/&gt;    -- di storicizzazione)&lt;br/&gt;    INSERT&lt;br/&gt;      INTO DPA_ROLE_HISTORY&lt;br/&gt;        (&lt;br/&gt;          SYSTEM_ID ,&lt;br/&gt;          ACTION_DATE ,&lt;br/&gt;          UO_ID ,&lt;br/&gt;          ROLE_TYPE_ID ,&lt;br/&gt;          ORIGINAL_CORR_ID ,&lt;br/&gt;          ACTION ,&lt;br/&gt;          ROLE_DESCRIPTION,&lt;br/&gt;          ROLE_ID&lt;br/&gt;        )&lt;br/&gt;        VALUES&lt;br/&gt;        (&lt;br/&gt;          seqrolehistory.nextval,&lt;br/&gt;          sysdate,&lt;br/&gt;          :new.id_uo,&lt;br/&gt;          :new.id_tipo_ruolo,&lt;br/&gt;          :new.original_id,&lt;br/&gt;          &apos;S&apos;,&lt;br/&gt;          :new.var_desc_corr || &apos; (&apos; || :new.var_codice || &apos;)&apos;,&lt;br/&gt;          :new.system_id&lt;br/&gt;        );&lt;br/&gt;    &lt;br/&gt;  else&lt;br/&gt;    INSERT&lt;br/&gt;      INTO DPA_ROLE_HISTORY&lt;br/&gt;        (&lt;br/&gt;          SYSTEM_ID ,&lt;br/&gt;          ACTION_DATE ,&lt;br/&gt;          UO_ID ,&lt;br/&gt;          ROLE_TYPE_ID ,&lt;br/&gt;          ORIGINAL_CORR_ID ,&lt;br/&gt;          ACTION ,&lt;br/&gt;          ROLE_DESCRIPTION,&lt;br/&gt;          ROLE_ID&lt;br/&gt;        )&lt;br/&gt;        VALUES&lt;br/&gt;        (&lt;br/&gt;          seqrolehistory.nextval,&lt;br/&gt;          sysdate,&lt;br/&gt;          :new.id_uo,&lt;br/&gt;          :new.id_tipo_ruolo,&lt;br/&gt;          :new.original_id,&lt;br/&gt;          &apos;M&apos;,&lt;br/&gt;          :new.var_desc_corr || &apos; (&apos; || :new.var_codice || &apos;)&apos;,&lt;br/&gt;          :new.system_id&lt;br/&gt;        );&lt;br/&gt;    &lt;br/&gt;  end if;&lt;br/&gt;&lt;br/&gt;END; </body>
<triggerTime>BEFORE</triggerTime>
<condition>new.cha_tipo_urp = &apos;R&apos; and&lt;br/&gt;      new.cha_tipo_ie = &apos;I&apos; and&lt;br/&gt;        new.dta_fine is null and&lt;br/&gt;        ( new.id_old != old.id_old or &lt;br/&gt;          new.var_codice != old.var_codice or &lt;br/&gt;          new.var_desc_corr != old.var_desc_corr or&lt;br/&gt;          new.id_uo != old.id_uo or&lt;br/&gt;          new.id_tipo_ruolo != old.id_tipo_ruolo)</condition>
<owner>695B8809-E92B-A363-7727-CAD83203B851</owner>
<table>0317F2DB-364C-1088-B6E0-C1AB95F1D212</table>
</TriggerOraclev10g>